<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flood Maps</title>
  <meta name="description" content="">
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link href="https://www.mapbox.com/base/latest/base.css" rel="stylesheet">
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.4/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.4/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <script src="js/vendor/modernizr-2.8.3.min.js"></script>
  <style>
    html {
      background-image: none;
      background-repeat: no-repeat;
    }

    body {
      background: none;
    }

    h1 {
      font-size: 3em;
      text-shadow: -1px 1px 2px rgba(255, 255, 255, 0.5);
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    #map-panel {
      position: relative;
      z-index: 100;
    }

    #map-query {
      padding: 5px;
      height: 30px;
    }
  </style>
</head>

<body>

  <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

  <!-- Content -->
  <div id='map'></div>

  <div data-map='legend' id='map-panel' class='limiter'>

    <h1>Chennai Flood Map</h1>
    <p>This map visualizes the low lying areas in the city (darker blue) which are plone to flooding during heavy rainfall.</p>

    <div class='col3 contain dark fill-navy pad1'>
      <h5>Locations <a href="#" class="truncate strong bloxk small" onclick='mapLocate("reset");'>
  (reset)
</a></h5>

      <div class="space-bottom1">
        <ul>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapLocate("cooum-river");'>
        Cooum River
      </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapLocate("adyar-river");'>
        Adyar River
      </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapLocate("pallikaranai");'>
        Pallikaranai Marsh
      </a>
          </li>
        </ul>
      </div>

      <h5>Layers</h5>

      <div class="space-bottom1">
        <ul>
          <li>
            <a data-map-layer='cartodem' href="#" class="truncate strong bloxk small " onclick='mapToggle("cartodem");'>
          Low lying areas
        </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small " onclick='mapToggle("relief-camps");'>
          Flood relief camps
        </a>
          </li>
          <ul>
            <li data-map-layer='chennai-relief-camps'>Camps (All)</li>
            <li data-map-layer='chennai-relief-camps-22nov'>Camps (Nov 22)</li>
          </ul>
        </ul>
      </div>

      <h5>Highlight <a href="#" class="truncate strong bloxk small" onclick='mapHighlightReset();'>
  (reset)
</a></h5>

      <div class="space-bottom1">
        <ul>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapHighlight("water","red");'>
          Waterbodies
        </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small " onclick='mapHighlight("road-subways","red");'>
          Road Subways & Tunnels
        </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapHighlight("road-bridges","red");'>
          Road Flyovers & Bridges
        </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapHighlight("railway-stations","red");'>
          Railway Stations
        </a>
          </li>
        </ul>
      </div>


      <div class="space-bottom1">
        <h5>Data Sources</h5>
        <ul>
          <li><a href="http://bhuvan.nrsc.gov.in/data/download/index.php">ISRO/CartoDEM v3 elevation data</a></li>
        </ul>
      </div>

      <input id='map-query' type='text' value='' class='stretch' placeholder="Locate feature" />

    </div>

  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script>
    window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')

    // Define map locations
    var mapLocation = {
      "reset": {
        "center": [80.24, 13.06],
        "zoom": 11,
        "pitch": 20,
        "bearing": -40
      },
      "pallikaranai": {
        "center": [80.22, 12.926],
        "zoom": 13.8,
        "pitch": 45,
        "bearing": 90
      },
      "adyar-river": {
        "center": [80.261, 13.014],
        "zoom": 13.8,
        "pitch": 60,
        "bearing": -64
      },
      "cooum-river": {
        "center": [80.281, 13.074],
        "zoom": 13.8,
        "pitch": 60,
        "bearing": -64
      }
    };


    // Simple map
    mapboxgl.accessToken = 'pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiemdYSVVLRSJ9.g3lbg_eN0kztmsfIPxa9MQ';
    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/planemad/cih4qzr0w0012awltzvpie7qa', //stylesheet location
    });
    mapLocate("reset");

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.Navigation());

    // Add a vector layer
    map.on('style.load', function() {
      map.addSource('terrain-data', {
        type: 'vector',
        url: 'mapbox://mapbox.mapbox-terrain-v2'
      });
      map.addLayer({
        "id": "terrain-data",
        "type": "line",
        "source": "terrain-data",
        "source-layer": "contour",
        "layout": {
          "line-join": "round",
          "line-cap": "round"
        },
        "paint": {
          "line-color": "#ff69b4",
          "line-opacity": "0.3",
          "line-width": 1
        }
      });
    });

    // Define a layer collection for easy styling
    var mapLayerCollection = {
      "water": ["water", "waterway-river-canal", "waterway-small"],
      "road-bridges": ["bridge-main","bridge-street","bridge-trunk","bridge-motorway"],
      "cartodem": ["chennai-cartodem"],
      "buildings": ["building"],
      "road-subways": ["tunnel-motorway","tunnel-trunk","tunnel-main","tunnel-street"],
      "relief-camps": ["chennai-relief-camps","chennai-relief-camps-22nov"]
    };

    var defaultStyle = {};

    // Highlight a layer collection
    function mapHighlight(collectionName, color) {

      // Loop through collection and store defaults before changing them
      for (var i = 0; i < mapLayerCollection[collectionName].length; i++) {

        var obj = mapLayerCollection[collectionName][i];

        console.log(obj);

        // Choose an appropriate property to change
        if (map.getLayer(obj).type == 'raster')
          prop = 'raster-opacity';
        if (map.getLayer(obj).type == 'fill')
          prop = 'fill-color';
        if (map.getLayer(obj).type == 'line')
          prop = 'line-color';
        if (map.getLayer(obj).type == 'circle')
          prop = 'circle-color';

        var propObj = {};
        propObj[prop] = map.getPaintProperty(obj, prop);

        defaultStyle[obj] = propObj;
        map.setPaintProperty(obj, prop, color);

      }

    };

    // Reset style of a collection to default
    function mapHighlightReset() {

      for (var collectionName in mapLayerCollection) {
        // Loop through collection and and reset properties to stored defaults
        for (var i = 0; i < mapLayerCollection[collectionName].length; i++) {

          var obj = mapLayerCollection[collectionName][i];
          var prop;

          // Choose an appropriate property to change
          if (map.getLayer(obj).type == 'raster')
            prop = 'raster-opacity';
          if (map.getLayer(obj).type == 'fill')
            prop = 'fill-color';
          if (map.getLayer(obj).type == 'line')
            prop = 'line-color';
          if (map.getLayer(obj).type == 'circle')
            prop = 'circle-color';

          // Revert to default style if known
          if (defaultStyle[obj][prop])
            map.setPaintProperty(obj, prop, defaultStyle[obj][prop]);

        }
      }

    };

    // Toggle visibility of a layer collection using opacity
    function mapToggle(collectionName) {

      // Loop through collection and toggle visibility
      for (var i = 0; i < mapLayerCollection[collectionName].length; i++) {

        var obj = mapLayerCollection[collectionName][i];
        var prop;

        // Choose an appropriate property to change
        if (map.getLayer(obj).type == 'raster')
          prop = 'raster-opacity';
        if (map.getLayer(obj).type == 'fill')
          prop = 'fill-opacity';
        if (map.getLayer(obj).type == 'line')
          prop = 'line-opacity';
        if (map.getLayer(obj).type == 'circle')
          prop = 'circle-opacity';

        map.setPaintProperty(obj, prop, !map.getPaintProperty(obj, prop));

      }

    };

    //Location functions
    // Set pitch and fly to location
    function mapLocate(location) {
      map.setPitch(mapLocation[location].pitch);
      map.flyTo(mapLocation[location]);
    }

    // Live map query
    map.on('style.load', function(e) {
      map.on('mousemove', function(e) {
        map.featuresAt(e.point, {
          radius: 4
        }, function(err, features) {
          if (err) throw err;
          var featuresList = '';
          var feature = '';
          for (var i = 0; i < 1; i++) {
            if (features[i].properties.class)
              featuresList += features[i].properties.class + ' ';
            if (features[i].properties.type)
              featuresList += features[i].properties.type + ' ';
            if (features[i].properties.name)
              featuresList += ':' + features[i].properties.name;
          }
          $('#map-query').attr('value', featuresList);
        });
      });

      // Popups on click
      map.on('click', function(e) {
        map.featuresAt(e.point, {
          radius: 10,
          layer: ['chennai-relief-camps', 'chennai-relief-camps-22nov'],
          includeGeometry: true
        }, function(err, features) {
          console.log('features here', features);
          if (features.length > 0) {
            var popup = new mapboxgl.Popup()
              .setLngLat(features[0].geometry.coordinates)
              .setText(features[0].properties.Name)
              .addTo(map);
          }
        });
      });
    });
  </script>
  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>
</body>

</html>
