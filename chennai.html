<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flood Maps</title>
  <meta name="description" content="">
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link href="https://www.mapbox.com/base/latest/base.css" rel="stylesheet">
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.4/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.4/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <script src="js/vendor/modernizr-2.8.3.min.js"></script>
  <style>
    html {
      background-image: none;
      background-repeat: no-repeat;
    }

    body {
      background: none;
    }

    h1 {
      font-size: 3em;
      margin-top:0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    #map-query {
      padding: 5px;
      height: 30px;
      position: relative;
      left: 120%;
      background: rgba(0,0,0,0.4);
      border-width: 0;
    }

    .map-legend-circle {
      width: 10px;
      height: 10px;
      background: red;
      -moz-border-radius: 50px;
      -webkit-border-radius: 50px;
      border-radius: 50px;
      float: left;
      margin: 5px 7px 0 0;
    }
  </style>
</head>

<body>

  <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

  <!-- Content -->
  <div id='map'></div>

  <div id='sidebar' class='pin-left col3 pad2 dark fill-navy'>

    <h1>Chennai Flooded Street Map</h1>
    <img class="space-bottom1" src="https://cloud.githubusercontent.com/assets/126868/11440554/86851886-9529-11e5-9bf5-55abcc223057.gif">
    <p>Report a flooded street by clicking on it. This crowdsourced map and data is <a href="#">open</a>.</p>

    <div data-map='legend'>

      <h5>Flood Layers</h5>

      <div class="space-bottom1">
        <ul>
          <li>
            <a data-map-layer='cartodem' href="#" class="truncate strong bloxk small" onclick='mapToggle(this);'>
          Terrain
        </a>
          </li>
          <li>
            <a data-map-layer='chennai-relief-camps-22nov' href="#" class="truncate strong bloxk small " onclick='mapToggle(this);'>
          Flood relief camps (Open on Nov 22)
        </a>
          </li>
          <li>
            <a data-map-layer='chennai-relief-camps' href="#" class="truncate strong bloxk small " onclick='mapToggle(this);'>
          Flood relief camps (Including closed)
        </a>
          </li>
          <li>
            <a data-map-layer='chennai-water-logged-points' href="#" class="truncate strong bloxk small " onclick='mapToggle(this);'>
          Water logged points
        </a>
          </li>
        </ul>
      </div>

      <h5>Locations <a href="#" class="truncate strong bloxk small" onclick='mapLocate("reset");'>
  (reset)
</a></h5>

      <div class="space-bottom1">
        <ul>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapLocate("aminjikarai");'>
        Aminjikarai
      </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapLocate("st-thomas-mt");'>
        St Thomas Mt
      </a>
          </li>
          <li>
            <a href="#" class="truncate strong bloxk small" onclick='mapLocate("tambaram");'>
        Tambaram
      </a>
          </li>
        </ul>
      </div>

      <h5>Highlight <a href="#" class="truncate strong bloxk small" onclick='mapHighlightReset();'>
  (reset)
</a></h5>

      <div class="space-bottom1">
        <ul>
          <li>
            <a href="#" data-map-layer-highlight='red' data-map-layer='water' class="truncate strong bloxk small" onclick='mapHighlight(this);'>
          Waterbodies
        </a>
          </li>
          <li>
            <a href="#" data-map-layer-highlight='red' data-map-layer='road-subways' class="truncate strong bloxk small " onclick='mapHighlight(this);'>
          Road Subways & Tunnels
        </a>
          </li>
          <li>
            <a href="#" data-map-layer-highlight='red' data-map-layer='road-bridges' class="truncate strong bloxk small" onclick='mapHighlight(this);'>
          Road Flyovers & Bridges
        </a>
          </li>
        </ul>
      </div>

      <input id='map-query' type='text' value='' class='stretch' placeholder="Map feature" />

    </div>

  </div>

  <div class="pad2 col8 space-bottom2 dark" style="position: absolute; z-index: 1000; bottom: 0; right: 0">
    <div id="copy" class="pad2 fill-darken3 round prose prose-big col12" style="display: block;">Poor infrastructure and unplanned development results in constant flooding in Chennai every monsoon. How bad is the situation? Nobody knows.</div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="js/mapbox-gl-js-common.js"></script>
  <script>
    window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')

    // Define map locations
    var mapLocation = {
      "reset": {
        "center": [80.24, 13.06],
        "zoom": 11,
        "pitch": 20,
        "bearing": -40
      },
      "pallikaranai": {
        "center": [80.22, 12.926],
        "zoom": 13.8,
        "pitch": 45,
        "bearing": 90
      },
      "adyar-river": {
        "center": [80.261, 13.014],
        "zoom": 13.8,
        "pitch": 60,
        "bearing": -64,
        "highlight": "water"
      },
      "cooum-river": {
        "center": [80.281, 13.074],
        "zoom": 13.8,
        "pitch": 60,
        "bearing": -64
      },
      "tambaram": {
        "center": [80.09, 12.9],
        "zoom": 13.8,
        "pitch": 80,
        "bearing": -10
      },
      "aminjikarai": {
        "center": [80.21, 13.07],
        "zoom": 13.8,
        "pitch": 80,
        "bearing": -10
      },
      "st-thomas-mt": {
        "center": [80.19, 13.01],
        "zoom": 13.8,
        "pitch": 80,
        "bearing": -10
      }
    };


    // Simple map
    mapboxgl.accessToken = 'pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiemdYSVVLRSJ9.g3lbg_eN0kztmsfIPxa9MQ';
    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/planemad/cih4qzr0w0012awltzvpie7qa', //stylesheet location
    });
    mapLocate("reset");

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.Navigation());

    // Add a vector layer
    map.on('style.load', function() {
      map.addSource('terrain-data', {
        type: 'vector',
        url: 'mapbox://mapbox.mapbox-terrain-v2'
      });
      map.addLayer({
        "id": "terrain-data",
        "type": "line",
        "source": "terrain-data",
        "source-layer": "contour",
        "layout": {
          "line-join": "round",
          "line-cap": "round"
        },
        "paint": {
          "line-color": "#ff69b4",
          "line-opacity": "0.3",
          "line-width": 1
        }
      });
    });

    // Define a layer collection for easy styling
    var mapLayerCollection = {
      "water": ["water", "waterway-river-canal", "waterway-small"],
      "road-bridges": ["bridge-main", "bridge-street", "bridge-trunk", "bridge-motorway"],
      "cartodem": ["chennai-cartodem"],
      "buildings": ["building"],
      "road-subways": ["tunnel-motorway", "tunnel-trunk", "tunnel-main", "tunnel-street"],
      "chennai-relief-camps": ["chennai-relief-camps"],
      "chennai-relief-camps-22nov": ["chennai-relief-camps-22nov"],
      "chennai-water-logged-points": ["chennai-water-logged-points"],
      "road": [
        'road-main',
        'road-construction',
        'road-rail',
        'road-motorway',
        'road-trunk',
        'road-street',
        'road-service-driveway',
        'road-path',
        'tunnel-motorway',
        'tunnel-trunk',
        'tunnel-main',
        'tunnel-street',
        'bridge-main',
        'bridge-street',
        'bridge-trunk',
        'bridge-motorway',
        'road-street_limited'
      ]
    };

    map.on('style.load', function(e) {

      //Live query
      map.on('mousemove', function(e) {
        map.featuresAt(e.point, {
          radius: 4
        }, function(err, features) {
          if (err) throw err;
          var featuresList = '';
          var feature = '';
          for (var i = 0; i < 1; i++) {
            if (features[i].properties.class)
              featuresList += features[i].properties.class + ' ';
            if (features[i].properties.type)
              featuresList += features[i].properties.type + ' ';
            if (features[i].properties.name)
              featuresList += ':' + features[i].properties.name;
          }
          $('#map-query').attr('value', featuresList);
        });
      });

      // Popups on click
      map.on('click', function(e) {
        map.featuresAt(e.point, {
          radius: 10,
          layer: ['chennai-relief-camps', 'chennai-relief-camps-22nov'],
          includeGeometry: true
        }, function(err, features) {
          console.log('features here', features);
          if (features.length > 0) {
            var popupHTML = "<h5>" + features[0].properties.Name + "</h5><p>" + $("[data-map-layer=" + features[0].layer.id + "]").html() + "</p>"
            var popup = new mapboxgl.Popup()
              .setLngLat(features[0].geometry.coordinates)
              .setHTML(popupHTML)
              .addTo(map);
          }
        });
      });

      // Update map legend from styles
      $("[data-map-layer]").each(function(e) {

        // Get the color of the feature from the map
        var obj = $(this).attr('data-map-layer');

        try {
          var color = map.getPaintProperty(obj, 'circle-color');
          // Set the legend color
          $(this).prepend('<div class="map-legend-circle" style="background:' + array2rgb(color) + '"></div>');
        } catch (e) {};
      });

      // Select flooded roads
      var getRequest = new XMLHttpRequest();

      getRequest.open('GET', 'http://at.therateof.com:12123/places.geojson', false);
      getRequest.send(null);

      // var chennaiGeoJSON = JSON.stringify(JSON.parse(getRequest.responseText).files["small-chennai.geojson"].content);
      // alert(getRequest.responseText);
      var chennaiGeoJSON = JSON.parse(getRequest.responseText);

      var addedRoads = [];
      var addedFeatures = [];
      var deletedRoads = [];
      var gistRoads = [];

      for (var i = 0; i < chennaiGeoJSON.features.length; i++) {
        addedRoads.push(chennaiGeoJSON.features[i].properties.osm_id);
        addedFeatures.push(chennaiGeoJSON.features[i]);
      }
      // var selectedRoadsGeoJSON = {};
      // selectedRoadsGeoJSON["type"] = "FeatureCollection";
      // selectedRoadsGeoJSON["features"] = [];
      var selectedRoadsSource = new mapboxgl.GeoJSONSource({
        'data': chennaiGeoJSON
      });
      map.addSource('selected-roads', selectedRoadsSource);
      map.addLayer({
        'id': 'selected-roads',
        'type': 'line',
        'source': 'selected-roads',
        'paint': {
          'line-color': 'rgba(255,5,230,1)',
          'line-width': 10,
          'line-opacity': 0.3
        }
      });

      // Road selection
      $(window).keydown(function(e) {
        if (e.ctrlKey)
          console.log('Control Down');
        ctrlKey = true;
      });
      // Toggle way selection on click
      map.on('click', function(e) {
        map.featuresAt(e.point, {
          radius: 5,
          includeGeometry: true,
          layer: mapLayerCollection["road"]
        }, function(err, features) {
          if (err)
            throw err;
          for (var i = 0; i < features.length; i++) {
            var tempObj = {};
            var index = addedRoads.indexOf(features[i].properties.osm_id);
            var postRequest = new XMLHttpRequest();
            var formData = new FormData();

            if (index !== -1 && addedFeatures[index] && (addedFeatures[index].geometry.coordinates.length == features[i].geometry.coordinates.length)) {

              console.log("unselect");

              //Create temp object
              tempObj.geometry = features[i].geometry;
              tempObj.properties = features[i].properties;
              tempObj.properties["is_flooded"] = false;
              console.log(JSON.stringify(tempObj));

              //Remove from all arrays
              chennaiGeoJSON['features'].splice(index, 1);
              addedRoads.splice(index, 1);
              addedFeatures.splice(index, 1);

              //Add tempObj to a formData to deal with "XMLHttpRequest"
              formData.append("data", JSON.stringify(tempObj));

              //Push temp object to server
              postRequest.open('POST', 'http://at.therateof.com:12123/save', false);
              postRequest.send(formData);
              // alert(postRequest.status);
              break;

            } else if (features[i].layer['type'] === 'line' && (features[i].geometry['type'] === 'LineString' ||
                features[i].geometry['type'] === 'MultiLineString')) {

              console.log("select");

              //Create temp object
              tempObj.geometry = features[i].geometry;
              tempObj.properties = features[i].properties;
              tempObj.properties["is_flooded"] = true;
              console.log(JSON.stringify(tempObj));

              //Push to all arrays
              addedFeatures.push(tempObj);
              chennaiGeoJSON.features.push(tempObj);
              addedRoads.push(features[i].properties.osm_id);

              //Add tempObj to a formData to deal with "XMLHttpRequest"
              formData.append("data", JSON.stringify(tempObj));

              //Push temp object to server
              postRequest.open('POST', 'http://at.therateof.com:12123/save', false);
              postRequest.send(formData);
              break;
            }
          }
          selectedRoadsSource.setData(chennaiGeoJSON);
        });
      });
    });

    function array2rgb(color) {
      // Combine and return the values
      return 'rgba(' + color.map(function(x) {
        return x * 255;
      }).join() + ')';
    }
  </script>
</body>

</html>
